{% extends 'frontend/base.html' %}

{% block title %}Devices - LATRA GPS{% endblock %}

{% block page_title %}Devices{% endblock %}

{% block content %}
<div class="device_inner_content">
        
    <div class="table-responsive">
        <div class="table-header d-flex justify-content-between align-items-center p-3">
            <h5>Devices List</h5>

            <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
                        <i class="fas fa-plus me-1"></i>Add Device
                    </button>
                <div>
                    <div class="input-group me-3" style="width: 300px;">
                        <span class="input-group-text bg-light">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" id="searchInput" class="form-control" 
                                placeholder="Search in table..." 
                                onkeyup="filterTable()" 
                                style="border-left: none;">
                        <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="searchInfo" class="alert alert-info d-none mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="searchResults"></span>
                        <button type="button" class="btn-close ms-2" onclick="clearSearch()" style="float: right;"></button>
                    </div>
                </div>
            </div>

        </div>
        
        <table id="dataTable" class="table table-hover w-100">
            <thead class="table-dark">
                
                <tr>
                    <th><i class="fas fa-calendar"></i> SN</th>
                    <th><i class="fas fa-microchip"></i> IMEI</th>
                    <th><i class="fas fa-calendar"></i> Date Created</th>
                    <th><i class="fas fa-microchip"></i> Action</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for device in devices %}
                <tr>
                    <td>
                        <!-- {{device.id}} -->
                        {{forloop.counter}}
                    </td>
                    <td>
                        {{device.imei_number}}
                    </td>
                    <td>
                        <small>{{ device.created_at|date:"Y-m-d H:i:s" }}</small>
                    </td>
                    <td>
                        <a href="" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editDeviceModal{{device.id}}"><i class="fa fa-edit"></i></a>
                        <a href="" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteDeviceModal{{device.id}}"><i class="fa fa-trash"></i></a>
                        <a href="" class="btn btn-sm btn-warning" data-bs-toggle="offcanvas" data-bs-target="#deviceDetailView{{device.id}}"><i class="fa fa-eye"></i></a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="12" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No devices available yet.</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            </tbody>
        </table>
        
        <!-- No Results Message -->
        <div id="noResults" class="text-center py-4 d-none">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <p class="text-muted">No results found for your search.</p>
            <button class="btn btn-outline-primary" onclick="clearSearch()">
                <i class="fas fa-times me-1"></i>Clear Search
            </button>
        </div>
    </div>

</div>

<!-- Add Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-microchip me-2"></i>Add New Device
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addDeviceForm" action="{% url 'frontend:device' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="deviceImei" class="form-label">IMEI Number</label>
                        <input type="text" class="form-control" id="deviceImei" 
                               placeholder="Enter 15-digit IMEI number" maxlength="15" pattern="[0-9]{15}" name="deviceImei" required>
                        <div class="form-text">IMEI must be exactly 15 digits</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" onclick="addDevice()" name="add_device_btn">
                            <i class="fas fa-plus me-1"></i>Add Device
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% for device in devices %}
<!-- Update Device Modal -->
<div class="modal fade" id="editDeviceModal{{device.id}}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-microchip me-2"></i>Edit Device  #{{device.imei_number}}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="EditDeviceForm" action="{% url 'frontend:device' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="deviceImei" class="form-label">IMEI Number</label>
                        <input type="hidden" name="device_id" value="{{ device.id }}">
                        <input type="text" class="form-control" id="deviceImei" 
                               placeholder="Enter 15-digit IMEI number" value="{{device.imei_number}}" maxlength="15" pattern="[0-9]{15}" name="deviceImei" required>
                        <div class="form-text">IMEI must be exactly 15 digits</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" name="edit_device_btn">
                            <i class="fas fa-edit"></i> Edit Device
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% for device in devices %}
<!-- Update Device Modal -->
<div class="modal fade" id="deleteDeviceModal{{device.id}}" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash me-2"></i>Delete Device  {{device.imei_number}}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="DeleteDeviceForm" action="{% url 'frontend:device' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <input type="hidden" name="device_id" value="{{ device.id }}">
                        <p>Aye you sure you want to delete device Imei : {{device.imei_number}} ?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" name="delete_device_btn">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% for device in devices %}
<div class="offcanvas offcanvas-end w-100" data-bs-backdrop="static" tabindex="-1" id="deviceDetailView{{device.id}}" aria-labelledby="deviceDetailView{{device.id}}Label">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="deviceDetailView{{device.id}}Label">Device Imei ~ {{device.imei_number}}</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <div class="table-responsive">
      <table id="dataTable" class="table table-hover w-100">
            <thead class="table-dark">    
                <tr>
                    <th><i class="fas fa-calendar"></i> ID</th>
                    <th><i class="fas fa-microchip"></i> IMEI</th>
                    <th><i class="fas fa-calendar"></i> Date Created</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <!-- {{device.id}} -->
                        {{device.id}}
                    </td>
                    <td>
                        {{device.imei_number}}
                    </td>
                    <td>
                        <small>{{ device.created_at|date:"Y-m-d H:i:s" }}</small>
                    </td>
                </tr>
            </tbody>
            </tbody>
        </table>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}